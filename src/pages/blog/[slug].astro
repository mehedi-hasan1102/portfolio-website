---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { formatDate } from '../../utils/formatDate';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);
const currentIndex = allPosts.findIndex(post => post.slug === entry.slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
---

<Layout>
  <article class="py-20 px-6 bg-white dark:bg-gray-950">
    <div class="max-w-3xl mx-auto">
      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-2 mb-4">
          <time class="text-sm font-medium text-gray-600 dark:text-gray-400">
            {formatDate(entry.data.pubDate)}
          </time>
          {entry.data.updatedDate && (
            <span class="text-xs text-gray-500 dark:text-gray-500">
              (Updated {formatDate(entry.data.updatedDate)})
            </span>
          )}
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
          {entry.data.title}
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-6">
          {entry.data.description}
        </p>
        {entry.data.image && (
          <img 
            src={entry.data.image} 
            alt={entry.data.title}
            class="w-full h-96 object-cover rounded-xl mb-8"
          />
        )}
        <div class="flex items-center gap-4 pb-6 border-b border-gray-200 dark:border-gray-800">
          <span class="text-sm text-gray-600 dark:text-gray-400">
            By <span class="font-semibold text-gray-900 dark:text-white">{entry.data.author}</span>
          </span>
          <span class="text-gray-300 dark:text-gray-700">â€¢</span>
          <span class="text-sm text-gray-600 dark:text-gray-400">
            {Math.ceil(Math.random() * 10 + 5)} min read
          </span>
        </div>
      </header>

      <!-- Content -->
      <div class="prose dark:prose-invert max-w-none mb-12">
        <Content />
      </div>

      <!-- Tags -->
      {entry.data.tags.length > 0 && (
        <div class="border-t border-gray-200 dark:border-gray-800 pt-8 mb-12">
          <div class="flex flex-wrap gap-2">
            {entry.data.tags.map((tag: string) => (
              <a 
                href={`/blog?tag=${tag}`}
                class="inline-block px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-sm font-medium rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors"
              >
                #{tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Navigation -->
      {(prevPost || nextPost) && (
        <nav class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-200 dark:border-gray-800 pt-8">
          {prevPost ? (
            <a 
              href={`/blog/${prevPost.slug}`}
              class="group flex items-center gap-4 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 hover:border-gray-900 dark:hover:border-white transition-all"
            >
              <svg class="w-5 h-5 text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              <div>
                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Previous</p>
                <p class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {prevPost.data.title}
                </p>
              </div>
            </a>
          ) : (
            <div></div>
          )}
          {nextPost ? (
            <a 
              href={`/blog/${nextPost.slug}`}
              class="group flex items-center gap-4 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 hover:border-gray-900 dark:hover:border-white transition-all md:text-right md:flex-row-reverse"
            >
              <svg class="w-5 h-5 text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
              <div>
                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Next</p>
                <p class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                  {nextPost.data.title}
                </p>
              </div>
            </a>
          ) : (
            <div></div>
          )}
        </nav>
      )}

      <!-- Back to Blog -->
      <div class="mt-12 text-center">
        <a 
          href="/#blog"
          class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-semibold transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Articles
        </a>
      </div>
    </div>
  </article>
</Layout>

<style>
  :global(.prose) {
    --prose-body: rgb(55 65 81);
    --prose-headings: rgb(17 24 39);
    --prose-lead: rgb(107 114 128);
    --prose-links: rgb(37 99 235);
    --prose-bold: rgb(17 24 39);
    --prose-counters: rgb(107 114 128);
    --prose-bullets: rgb(209 213 219);
    --prose-hr: rgb(229 231 235);
    --prose-quotes: rgb(107 114 128);
    --prose-quote-borders: rgb(229 231 235);
    --prose-captions: rgb(107 114 128);
    --prose-code: rgb(17 24 39);
    --prose-pre-code: rgb(209 213 219);
    --prose-pre-bg: rgb(17 24 39);
    --prose-th-borders: rgb(209 213 219);
    --prose-td-borders: rgb(229 231 235);
    --prose-kbd: rgb(17 24 39);
    --prose-kbd-bg: rgb(243 244 246);
  }

  :global(.dark .prose) {
    --prose-body: rgb(209 213 219);
    --prose-headings: rgb(243 244 246);
    --prose-lead: rgb(156 163 175);
    --prose-links: rgb(96 165 250);
    --prose-bold: rgb(243 244 246);
    --prose-counters: rgb(156 163 175);
    --prose-bullets: rgb(55 65 81);
    --prose-hr: rgb(55 65 81);
    --prose-quotes: rgb(156 163 175);
    --prose-quote-borders: rgb(55 65 81);
    --prose-captions: rgb(156 163 175);
    --prose-code: rgb(243 244 246);
    --prose-pre-code: rgb(209 213 219);
    --prose-pre-bg: rgb(0 0 0 / 0.5);
    --prose-th-borders: rgb(55 65 81);
    --prose-td-borders: rgb(31 41 55);
    --prose-kbd: rgb(243 244 246);
    --prose-kbd-bg: rgb(31 41 55);
  }
</style>
